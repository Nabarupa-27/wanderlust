<% layout('layouts/boilerplate') %>

  <div class="row">
    <div class="col-8 offset-2">

      <!-- Listing Title -->
      <h3 class="mb-3">
        <%= listing.title %>
      </h3>

      <!-- Listing Card -->
      <div class="card show-card mb-4">
        <img src="<%= listing.image?.url || 'https://via.placeholder.com/600x400?text=No+Image' %>"
          class="card-img-top show-img" alt="listing image" />

        <div class="card-body">
          <p class="card-text">
            <%= listing.description %>
          </p>

          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>Price:</strong>
              &#8377; <%= listing.price.toLocaleString("en-IN") %>
            </li>
            <li class="list-group-item">
              <strong>Location:</strong>
              <%= listing.location %>
            </li>
            <li class="list-group-item">
              <strong>Country:</strong>
              <%= listing.country %>
            </li>
          </ul>

          <!-- Listing Actions (ONLY OWNER) -->
          <% if (currentUser && listing.owner && listing.owner._id.equals(currentUser._id)) { %>
            <div class="mt-3 d-flex gap-2">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">
                Edit
              </a>

              <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
                <button class="btn btn-danger">Delete</button>
              </form>
            </div>
            <% } %>
        </div>
      </div>

      <hr />
      <h4 class="mb-3">Location on Map</h4>

      <div id="map" style="width: 100%; height: 300px; border-radius: 10px;"
        data-location="<%= listing.location %>, <%= listing.country %>"></div>

      <!-- Review Form -->
      <hr />
      <h4 class="mb-3">Leave a Review</h4>

      <% if (currentUser) { %>
        <form method="POST" action="/listings/<%= listing._id %>/reviews"
          class="p-3 border rounded bg-light mb-4 needs-validation" novalidate>

          <!-- Rating -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Rating</label>
            <div class="star-rating mb-2">
              <% for (let i=5; i>= 1; i--) { %>
                <input type="radio" name="review[rating]" id="star-<%= i %>" value="<%= i %>" required />
                <label for="star-<%= i %>">
                  <i class="fa-solid fa-star"></i>
                </label>
                <% } %>
            </div>
          </div>

          <!-- Comment -->
          <div class="mb-3">
            <label class="form-label fw-semibold">Comments</label>
            <textarea name="review[comment]" rows="4" class="form-control" placeholder="Write your experience here..."
              required minlength="5"></textarea>
          </div>

          <button class="btn btn-primary px-4">Submit Review</button>
        </form>
        <% } else { %>
          <p class="text-muted">Login to add a review.</p>
          <% } %>

            <!-- Reviews List -->
            <hr />
            <h4 class="mb-3">All Reviews</h4>

            <% if (listing.reviews.length===0) { %>
              <p class="text-muted">No reviews yet.</p>
              <% } else { %>
                <% for (let review of listing.reviews) { %>
                  <div class="card mb-3 shadow-sm">
                    <div class="card-body">

                      <% if (review.author) { %>
                        <p class="mb-1 fw-semibold text-muted">
                          @<%= review.author.username %>
                        </p>
                        <% } %>

                          <div class="mb-2">
                            <% for (let i=1; i <=5; i++) { %>
                              <% if (i <=review.rating) { %>
                                <i class="fa-solid fa-star text-warning"></i>
                                <% } else { %>
                                  <i class="fa-regular fa-star text-muted"></i>
                                  <% } %>
                                    <% } %>
                          </div>

                          <p class="mb-2">
                            <%= review.comment %>
                          </p>

                          <% if (currentUser && review.author && review.author.equals(currentUser._id)) { %>
                            <form method="POST"
                              action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                              <button class="btn btn-sm btn-outline-danger">
                                Delete Review
                              </button>
                            </form>
                            <% } %>

                    </div>
                  </div>
                  <% } %>
                    <% } %>

    </div>
  </div>
